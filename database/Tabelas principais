-- Usuários (você já deve ter; incluí colunas úteis)
CREATE TABLE app_user (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email            CITEXT UNIQUE NOT NULL,
  display_name     TEXT,
  avatar_url       TEXT,
  is_founder       BOOLEAN DEFAULT FALSE,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Seguidores (para 'followers' visibility)
CREATE TABLE user_follow (
  follower_id UUID REFERENCES app_user(id) ON DELETE CASCADE,
  followee_id UUID REFERENCES app_user(id) ON DELETE CASCADE,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (follower_id, followee_id)
);

-- Álbum de fotos / refeições
CREATE TABLE meal_photo (
  id                 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id            UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  taken_at           TIMESTAMPTZ,               -- quando foi tirada (EXIF se houver)
  uploaded_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  source             capture_source NOT NULL DEFAULT 'web',
  visibility         visibility NOT NULL DEFAULT 'private',
  meal               meal_type,                 -- classificado pelo usuário ou pela IA
  caption            TEXT,                      -- descrição do usuário
  -- Armazenamento
  original_url       TEXT NOT NULL,             -- R2/S3 URL (privado)
  display_url        TEXT NOT NULL,             -- versão redimensionada + watermark (pública/assinada)
  thumb_url          TEXT,                      -- 256px
  -- Integridade / dedupe
  sha256             TEXT,                      -- hash do arquivo para evitar duplicados
  exif_json          JSONB,                     -- EXIF normalizado
  width              INT,
  height             INT,
  -- Moderação
  moderation         moderation_status NOT NULL DEFAULT 'pending',
  moderation_reason  TEXT,
  -- Auditoria
  meta               JSONB DEFAULT '{}'::jsonb,
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX meal_photo_user_sha_idx ON meal_photo(user_id, sha256);

-- Saída de análise da IA (1:N, guardamos versões)
CREATE TABLE meal_analysis (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  photo_id          UUID NOT NULL REFERENCES meal_photo(id) ON DELETE CASCADE,
  analyzer_version  TEXT NOT NULL,                -- ex: "nfc-vision@2025-11-10"
  calories_kcal     NUMERIC(8,2),
  protein_g         NUMERIC(8,2),
  carbs_g           NUMERIC(8,2),
  fat_g             NUMERIC(8,2),
  fiber_g           NUMERIC(8,2),
  gi_estimate       NUMERIC(5,1),                 -- índice glicêmico
  gl_estimate       NUMERIC(6,1),                 -- carga glicêmica
  portion_quality   NUMERIC(4,2),                 -- 0–1 score (apresentação/porção)
  plan_alignment    NUMERIC(4,2),                 -- 0–1 quão perto do plano
  tags              TEXT[] ,                      -- ex: {frango,arroz,brocolis}
  raw_json          JSONB NOT NULL,               -- saída completa do modelo
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX meal_analysis_photo_idx ON meal_analysis(photo_id);

-- Pontuação consolidada por foto (1:1 com a melhor análise)
CREATE TABLE meal_score (
  photo_id        UUID PRIMARY KEY REFERENCES meal_photo(id) ON DELETE CASCADE,
  analysis_id     UUID NOT NULL REFERENCES meal_analysis(id) ON DELETE CASCADE,
  base_points     INT NOT NULL,       -- consistência + qualidade + alinhamento
  bonus_streak    INT NOT NULL,
  penalty_rules   INT NOT NULL,       -- atrasos, quebra de plano, etc.
  total_points    INT NOT NULL,
  computed_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Streaks diários de registro de refeição (por usuário)
CREATE TABLE user_streak (
  user_id       UUID PRIMARY KEY REFERENCES app_user(id) ON DELETE CASCADE,
  current_streak INT NOT NULL DEFAULT 0,
  best_streak    INT NOT NULL DEFAULT 0,
  last_day       DATE                 -- última data com pelo menos 1 foto válida
);

-- Regras do plano do usuário (alvo diário corrente; histórico recomendável)
CREATE TABLE user_daily_targets (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id        UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  day            DATE NOT NULL,                        -- chave do alvo
  kcal_target    INT,
  protein_g      NUMERIC(8,2),
  carbs_g        NUMERIC(8,2),
  fat_g          NUMERIC(8,2),
  fiber_g        NUMERIC(8,2),
  unique (user_id, day)
);

-- Reações/comentários (para feed social)
CREATE TABLE photo_like (
  photo_id UUID REFERENCES meal_photo(id) ON DELETE CASCADE,
  user_id  UUID REFERENCES app_user(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (photo_id, user_id)
);

CREATE TABLE photo_comment (
  id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  photo_id  UUID REFERENCES meal_photo(id) ON DELETE CASCADE,
  user_id   UUID REFERENCES app_user(id) ON DELETE CASCADE,
  body      TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
