-- Top 20 da semana atual
SELECT u.display_name, m.week_points, m.meals_count
FROM mv_user_points_week m
JOIN app_user u ON u.id = m.user_id
WHERE week_start = date_trunc('week', now())::date
ORDER BY m.week_points DESC
LIMIT 20;

-- Feed p√∫blico (mais novo)
SELECT p.*, a.calories_kcal, a.protein_g
FROM meal_photo p
LEFT JOIN LATERAL (
  SELECT * FROM meal_analysis a2
  WHERE a2.photo_id = p.id
  ORDER BY a2.created_at DESC
  LIMIT 1
) a ON TRUE
WHERE p.visibility = 'public' AND p.moderation = 'approved'
ORDER BY p.uploaded_at DESC
LIMIT 50;
