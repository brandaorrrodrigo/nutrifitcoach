-- Pontos por usu√°rio em janelas
CREATE MATERIALIZED VIEW mv_user_points_week AS
SELECT
  p.user_id,
  date_trunc('week', s.computed_at)::date AS week_start,
  sum(s.total_points) AS week_points,
  count(*)            AS meals_count
FROM meal_score s
JOIN meal_photo p ON p.id = s.photo_id
WHERE p.moderation = 'approved'
GROUP BY 1,2;

CREATE INDEX mv_user_points_week_idx ON mv_user_points_week (week_start DESC, week_points DESC);

-- Atualize periodicamente (cron/queue):
-- REFRESH MATERIALIZED VIEW CONCURRENTLY mv_user_points_week;
